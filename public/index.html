<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Survey System">
    <meta name="author" content="Michał Kutrzeba">

    <title>Survey System</title>
    <link href="modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="modules/animate.css/animate.min.css">
    <link rel="stylesheet" type="text/css" href="modules/Ionicons/css/ionicons.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">

    <script src="modules/react/react.js" type="text/javascript" charset="utf-8"></script>
    <script src="modules/react/react-dom.js" type="text/javascript" charset="utf-8"></script>
    <script src="modules/babel/browser.js" type="text/javascript" charset="utf-8"></script>
    <script src="modules/fetch/fetch.js" type="text/javascript" charset="utf-8"></script>

    <script type="text/babel" src="src/SurveyService.jsx"></script>
  </head>

  <body>
    <div id="app"></div>
  </body>

  <script type="text/babel">


    class Question extends React.Component
    {
      constructor(props) {
        super(props);
        this.state = {value: ''};
        if (typeof props.id == "undefined" || !props.id) {
          console.log('Statement doesn\'t have privided identifier.');
        }

        this.id = props.id;
        this.handleChange = this.handleChange.bind(this);
      }

      handleChange(event) {
        this.setState({value: event.target.value});
      }
    }

    class QuestionPercentage extends Question
    {
      handleChange(event) {
        this.setState({value: event.target.value});
        document
          .getElementById('statement-' + this.id + '-input-0-output')
          .innerHTML = event.target.value + '%';
      }

      render() {
        const title = this.props.title;
        const statementNo = this.id;

        return (
          <div className="card question-card hidden">
            <div className="card-block">
              <h4 className="card-title">{title}</h4>
              {this.state.error ? <p className="alert alert-danger"><strong>Error</strong> {this.state.error}</p> : null}
            </div>
            <div className="card-text">
              <output id="rangevalue"></output>
              <div className="clearfix"></div>
              <input
                className="form-control"
                id={'statement-' + statementNo + '-input-0'}
                type="range"
                name="response[]"
                min="0"
                max="100"
                step="1"
                defaultValue="0"
                onChange={this.handleChange} />
            </div>
            <div className="card-block">
              <div className="card-tect">
                <p className="h3 text-center" id={'statement-' + statementNo + '-input-0-output'}>0%</p>
              </div>
            </div>
          </div>
        )
      }
    }

    class QuestionQuick extends Question
    {
      render() {
        const title = this.props.title;
        const statementNo = this.props.no;

        return (
          <div className="card question-card hidden">
            <div className="card-block">
              <h4 className="card-title">{title}</h4>
              {this.state.error ? <p className="alert alert-danger"><strong>Error</strong> {this.state.error}</p> : null}
            </div>
            <div className="list-group list-group-flush">
              <label className="list-group-item">
                <input
                  id={'statement-' + statementNo + '-input-0'}
                  type="radio"
                  name={'response[' + statementNo + ']'}
                  value="1"
                  onChange={this.handleChange} />
                <span style={{marginLeft: "20px"}}>Yes</span>
              </label>
              <label className="list-group-item">
                <input
                  id={'statement-' + statementNo + '-input-1'}
                  type="radio"
                  name={'response[' + statementNo + ']'}
                  value="0"
                  onChange={this.handleChange} />
                <span style={{marginLeft: "20px"}}>No</span>
              </label>
              <label className="list-group-item">
                <input
                  id={'statement-' + statementNo + '-input-2'}
                  type="radio"
                  name={'response[' + statementNo + ']'}
                  value="2"
                  onChange={this.handleChange} />
                <span style={{marginLeft: "20px"}}>I don't know</span>
              </label>
            </div>
          </div>
        )
      }
    }


    class Landing extends React.Component
    {
      beginSurvey() {
        const startPage = document.querySelector('.start-page');
        const statementsBox = document.querySelector('.statements-box');
        startPage.classList.add('animated');
        startPage.classList.add('fadeOut');
        startPage.addEventListener('animationend', e => {
          startPage.classList.add('hidden');
          statementsBox.classList.remove('hidden');
          Statements.toggleStatemenent(0);
        });
      }

      render() {
        const title = this.props.title;
        const description = this.props.description;

        return (
          <div className="jumbotron start-page text-center">
            <h1 className="display-3">{title}</h1>
            <p className="lead">{description}</p>
            <hr className="my-4"/>
            <button type="" className="btn btn-primary btn-lg" onClick={this.beginSurvey}>Begin »</button>
          </div>
        )
      }
    }

    class Statements extends React.Component
    {

      static showStatement(statementNo) {
        const questionCard = document.querySelectorAll('.question-card')[statementNo];
        questionCard.classList.remove('hidden');
      }

      static hideStatements(callback) {
        const questionCards = document.querySelectorAll('.question-card');
        if (questionCards.length) {
          let val = '';
          for (let i = 0; i < questionCards.length; i++) {
            val = questionCards[i];
            val.classList.add('hidden');
          }
        }

        callback();
      }

      static toggleStatemenent(statementNo) {
        Statements.hideStatements(() => {
          Statements.showStatement(statementNo);
        });
      }

      /**
       * @param  {Array} props
       */
      constructor(props) {
        super(props);

        this.sendResponses = this.sendResponses.bind(this);

        /**
         * @type {Array}
         */
        this.statements = [];
      }

      /**
       * @param  {Object} e
       * @return {Void}
       */
      sendResponses(e) {
        e.preventDefault();
        const formData = [];
        for (let i = 0; i < this.statements.length; i++) {
          formData[i] = {
            statementId: this.statements[i].id,
            value: this.statements[i].state.value
          };
        }

        SurveyService.sendReplies(formData)
          .then((data) => {
            console.log(data);
            ReactDOM.render(
              <FinishPage/>,
              document.getElementById('app')
            );
          }).catch((data) => {
            data.response.json().then((data) => {
              console.log(data);
              let i = 0;
              const errorsRemapped = [];
              for (let i = 0; i < data.errors.length; i++) {
                errorsRemapped[data.errors[i].statementId] = data.errors[i];
              }

              for (let i = 0; i < this.statements.length; i++) {
                const stat = this.statements[i];
                const err = errorsRemapped[stat.id];
                let errorMsg = '';
                if (typeof err != 'undefined') {
                  errorMsg = err.message;
                }

                stat.setState({
                  value: stat.state.value,
                  error: errorMsg
                });
              }
            });
          });
      }

      /**
       * @return {Object}
       */
      render() {
        const statements = this.props.statements;
        let domStatements = [];
        for (let i = 0; i < statements.length; i++) {
          const statement = statements[i];
          if (1 == statement.response.type) {
            domStatements.push(
              <QuestionQuick
                id={statement.id}
                key={i}
                ref={(statement) => { this.statements.push(statement); }}
                title={statement.title}
                responses={statement.response} />
            );
          } else if (2 == statement.response.type) {
            domStatements.push(
              <QuestionPercentage
                id={statement.id}
                key={i}
                ref={(statement) => { this.statements.push(statement); }}
                title={statement.title}
                responses={statement.response} />
            );
          }
        }

        return (
          <form onSubmit={this.sendResponses} className="statements-box hidden" style={{height: "350px"}}>
            {domStatements}
            <Pagination pages={statements.length}/>
          </form>
        );
      }
    }

    class Pagination extends React.Component
    {
      constructor(props) {
        super(props);
        this.pages = this.props.pages;
        this.currentPage = 0;
      }

      setPage(page) {
        this.currentPage = page;
        Statements.toggleStatemenent(page);
        this.forceUpdate();
      }

      setPrevPage() {
        const page = this.currentPage - 1;
        if (page < 0) {
          return;
        }

        this.setPage(page);
        Statements.toggleStatemenent(page);
      }

      setNextPage() {
        const page = this.currentPage + 1;
        if (page >= this.pages) {
          return;
        }

        this.setPage(page);
        Statements.toggleStatemenent(page);
      }

      render() {
        const pages = this.pages;
        const current = this.currentPage;

        let htmlPages = [];
        for (let i = 0; i < pages; i++) {
          htmlPages.push(
            <li key={i} className={'page-item ' + ((current == i) ? 'active' : '')}>
              <a className="page-link" href="#" onClick={() => { this.setPage(i)} }>{i + 1}</a>
            </li>
          );
        }

        let finalBlock = '';
        if (current == pages - 1) {
          finalBlock = (
            <li className="page-item">
              <button className="page-link" type="submit">Send</button>
            </li>
          );
        } else {
          finalBlock = (
            <li className="page-item">
              <a className="page-link" href="#" onClick={() => { this.setNextPage()} }>Next</a>
            </li>
          );
        }

        return (
          <footer className="paginationFooter">
              <nav>
                <ul className="pagination pagination-lg justify-content-center">
                  <li className={'page-item ' + (0 == current ? 'disabled' :'')}>
                    <a className="page-link" href="#" onClick={() => { this.setPrevPage()} }>Previous</a>
                  </li>
                  {htmlPages}
                  {finalBlock}
                </ul>
              </nav>
          </footer>
        )
      }
    }

    class Body extends React.Component
    {
      constructor(props) {
        super(props);
        this.survey = this.props.survey;
      }

      render() {
        const survey = this.survey;

        return (
          <div>
            <Navi/>
            <div className="container">
              <Landing title={survey.title} description={survey.description} />
              <Statements statements={survey.statements} />
            </div>
          </div>
        )
      }
    }

    class Navi extends React.Component
    {
      render() {
        return (
          <nav className="navbar navbar-light bg-faded">
            <h1 className="navbar-brand mb-0">Survey System</h1>
          </nav>
        );
      }
    }

    class FinishPage extends React.Component
    {
        render() {
            return (
              <div>
                <div className="finish-page container mx-auto" style={{width: "600px"}}>
                  <div className="card text-center">
                    <div className="card-block">
                      <h4 className="card-title">Responses were sent.</h4>
                      <p className="card-text h1"><i className="text-success ion-checkmark-circled"></i></p>
                      <p className="card-text">Thanks for your time!</p>
                    </div>
                    <div className="card-footer text-muted">
                      <p>
                        <small className="text-muted mr-2">&copy; 2017</small>
                        <small className="text-muted mr-2"><a href="mailto:kutrzeba.michal@gmail.com"><i className="ion-paper-airplane"></i> Michał Kutrzeba</a></small>
                      </p>
                      <p className="text-muted h4"><a href="https://www.linkedin.com/in/micha%C5%82-kutrzeba-69134167/"><i className="ion-social-linkedin"></i></a></p>
                    </div>
                  </div>
                </div>
              </div>
            )
        }
    }

    SurveyService.getSurvey()
      .then((data) => {
        if (typeof data.success == 'undefined' || !data.success) {
          throw new Error('Error occured while fetching survey.');
        }

        ReactDOM.render(
          <Body survey={data.data}/>,
          document.getElementById('app')
        );
      }).catch((error) => {
        console.log('Request failed', error)
      });

    function checkStatus(response) {
      if (response.status >= 200 && response.status < 300) {
        return response
      } else {
        var error = new Error(response.statusText)
        error.response = response
        throw error
      }
    }
  </script>
</html>
