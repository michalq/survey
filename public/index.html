<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Survey System">
    <meta name="author" content="MichaÅ‚ Kutrzeba">

    <title>Survey System</title>
    <link href="modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="modules/animate.css/animate.min.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">

    <script src="modules/react/react.js" type="text/javascript" charset="utf-8"></script>
    <script src="modules/react/react-dom.js" type="text/javascript" charset="utf-8"></script>
    <script src="modules/babel/browser.js" type="text/javascript" charset="utf-8"></script>
    <script src="modules/fetch/fetch.js" type="text/javascript" charset="utf-8"></script>
  </head>

  <body>
    <div id="app"></div>
  </body>

  <script type="text/babel">
    class SurveyService {
      static getSurvey() {
        return fetch('/api/v1/survey')
          .then(checkStatus)
          .then(parseJSON);
      }
    }

    class QTypePercentage extends React.Component
    {
      render() {
        const title = this.props.title;
        const statementNo = this.props.no;

        return (
          <div className="card question-card hidden">
            <div className="card-block">
              <h4 className="card-title">{title}</h4>
            </div>
            <div className="card-text">
              <output id="rangevalue"></output>
              <div className="clearfix"></div>
              <input
                className="form-control"
                id={'statement-' + statementNo + '-input-0'}
                type="range"
                name="response[]"
                min="0"
                max="100"
                step="1"
                defaultValue="0"
                onChange={(e) => {
                  document.getElementById('statement-' + statementNo + '-input-0-output').innerHTML = e.target.value + '%';
                }} />
            </div>
            <div className="card-block">
              <div className="card-tect">
                <p className="h3 text-center" id={'statement-' + statementNo + '-input-0-output'}>0%</p>
              </div>
            </div>
          </div>
        )
      }
    }

    class QTypeQuick extends React.Component
    {
      render() {
        const title = this.props.title;
        const statementNo = this.props.no;

        return (
          <div className="card question-card hidden">
            <div className="card-block">
              <h4 className="card-title">{title}</h4>
            </div>
            <div className="list-group list-group-flush">
              <label className="list-group-item">
                <input id={'statement-' + statementNo + '-input-0'} type="radio" name={'response[' + statementNo + ']'} value="1"/>
                <span style={{marginLeft: "20px"}}>Yes</span>
              </label>
              <label className="list-group-item">
                <input id={'statement-' + statementNo + '-input-1'} type="radio" name={'response[' + statementNo + ']'} value="0"/>
                <span style={{marginLeft: "20px"}}>No</span>
              </label>
              <label className="list-group-item">
                <input id={'statement-' + statementNo + '-input-2'} type="radio" name={'response[' + statementNo + ']'} value="2"/>
                <span style={{marginLeft: "20px"}}>I don't know</span>
              </label>
            </div>
          </div>
        )
      }
    }


    class Landing extends React.Component
    {
      beginSurvey() {
        const startPage = document.querySelector('.start-page');
        const statementsBox = document.querySelector('.statements-box');
        startPage.classList.add('animated');
        startPage.classList.add('fadeOut');
        startPage.addEventListener('animationend', e => {
          startPage.classList.add('hidden');
          statementsBox.classList.remove('hidden');
          Statements.toggleStatemenent(0);
        });
      }

      render() {
        const title = this.props.title;
        const description = this.props.description;

        return (
          <div className="jumbotron start-page">
            <h1 className="display-3">{title}</h1>
            <p className="lead">{description}</p>
            <hr className="my-4"/>
            <button type="" className="btn btn-outline-success btn-lg pull-right" onClick={this.beginSurvey}>Begin</button>
          </div>
        )
      }
    }

    class Statements extends React.Component
    {

      static showStatement(statementNo) {
        const questionCard = document.querySelectorAll('.question-card')[statementNo];
        questionCard.classList.remove('hidden');
      }

      static hideStatements(callback) {
        const questionCards = document.querySelectorAll('.question-card');
        if (questionCards.length) {
          let val = '';
          for (let i = 0; i < questionCards.length; i++) {
            val = questionCards[i];
            val.classList.add('hidden');
          }
        }

        callback();
      }

      static toggleStatemenent(statementNo) {
        Statements.hideStatements(() => {
          Statements.showStatement(statementNo);
        });
      }

      render() {
        const statements = this.props.statements;
        let domStatements = [];
        for (let i = 0; i < statements.length; i++) {
          const statement = statements[i];
          if (1 == statement.response.type) {
            domStatements.push(
              <QTypeQuick no={i} key={i} title={statement.title} responses={statement.response}/>
            );
          } else if (2 == statement.response.type) {
            domStatements.push(
              <QTypePercentage no={i} key={i} title={statement.title} responses={statement.response} />
            );
          }
        }

        return (
          <div className="statements-box hidden" style={{height: "350px"}}>
            {domStatements}
            <Pagination pages={statements.length}/>
          </div>
        );
      }
    }

    class Pagination extends React.Component
    {
      constructor(props) {
        super(props);
        this.pages = this.props.pages;
        this.currentPage = 0;
      }

      setPage(page) {
        this.currentPage = page;
        Statements.toggleStatemenent(page);
        this.forceUpdate();
      }

      setPrevPage() {
        const page = this.currentPage - 1;
        if (page < 0) {
          return;
        }

        this.setPage(page);
        Statements.toggleStatemenent(page);
      }

      setNextPage() {
        const page = this.currentPage + 1;
        if (page >= this.pages) {
          return;
        }

        this.setPage(page);
        Statements.toggleStatemenent(page);
      }

      finishSurvey() {
        alert('OK');
      }

      render() {
        const pages = this.pages;
        const current = this.currentPage;

        let htmlPages = [];
        for (let i = 0; i < pages; i++) {
          htmlPages.push(
            <li key={i} className={'page-item ' + ((current == i) ? 'active' : '')}>
              <a className="page-link" href="#" onClick={() => { this.setPage(i)} }>{i + 1}</a>
            </li>
          );
        }

        let finalBlock = '';
        if (current == pages - 1) {
          finalBlock = (
            <li className="page-item">
              <a className="page-link" href="#" onClick={() => { this.finishSurvey()} }>Finish!</a>
            </li>
          );
        } else {
          finalBlock = (
            <li className="page-item">
              <a className="page-link" href="#" onClick={() => { this.setNextPage()} }>Next</a>
            </li>
          );
        }

        return (
          <footer className="paginationFooter">
              <nav>
                <ul className="pagination pagination-lg justify-content-center">
                  <li className={'page-item ' + (0 == current ? 'disabled' :'')}>
                    <a className="page-link" href="#" onClick={() => { this.setPrevPage()} }>Previous</a>
                  </li>
                  {htmlPages}
                  {finalBlock}
                </ul>
              </nav>
          </footer>
        )
      }
    }

    class Body extends React.Component
    {
      constructor(props) {
        super(props);
        this.survey = this.props.survey;
      }

      render() {
        const survey = this.survey;

        return (
          <div>
            <nav className="navbar navbar-light bg-faded">
              <h1 className="navbar-brand mb-0">Survey System</h1>
            </nav>
            <div className="container">
              <Landing title={survey.title} description={survey.description} />
              <Statements statements={survey.statements} />
            </div>
          </div>
        )
      }
    }

    SurveyService.getSurvey()
      .then((data) => {
        if (typeof data.success == 'undefined' || !data.success) {
          throw new Error('Error occured while fetching survey.');
        }

        ReactDOM.render(
          <Body survey={data.data}/>,
          document.getElementById('app')
        );
      }).catch((error) => {
        console.log('Request failed', error)
      });

    function checkStatus(response) {
      if (response.status >= 200 && response.status < 300) {
        return response
      } else {
        var error = new Error(response.statusText)
        error.response = response
        throw error
      }
    }

    function parseJSON(response) {
      return response.json()
    }
  </script>
</html>
